<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Batch CIK PDFs</title>
<style>
  body{font-family:sans-serif;margin:24px;max-width:900px}
  h1{font-size:20px;margin:0 0 14px}
  textarea{width:100%;min-height:160px;padding:10px;font-size:14px}
  button{padding:12px 16px;font-size:14px;cursor:pointer;margin-top:12px}
  .log{margin-top:16px;background:#fafafa;border:1px solid #ddd;padding:10px;font-family:monospace;white-space:pre-wrap}
  .ok{color:green}.err{color:#a00}
</style>
</head>
<body>
<h1>Form ID → PDFs (Batch)</h1>
<p>Enter one or more rows in the format: <code>Fund,EIN</code>. The source HTML, EIN seed, and paper format are fixed server-side.</p>

<textarea id="rows" placeholder="Defense VII, a Series of E1 VC, LLC,111111111
Defense VIII, a Series of E1 VC, LLC,222222222"></textarea><br>
<button id="go">Generate PDFs</button>

<div id="log" class="log"></div>

<script>
// your Apps Script endpoint (fixed)
const API = "https://script.google.com/macros/s/AKfycbyyDZuLteKAz7CPey3g33E_ws-6IElW0WZOJgCAd74fRyvIyL_49Sv_hSHJTkjX86V0yw/exec";

const slug = s => s.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");
const outName = fund => `${slug(fund)}cik_fornotary.pdf`;
const log = document.getElementById("log");
function say(m,cls=""){const d=document.createElement("div");if(cls)d.className=cls;d.textContent=m;log.appendChild(d);}

function parseRows(txt){
  const out=[];
  for (const line of txt.split(/\\r?\\n/)){
    const s=line.trim(); if(!s)continue;
    const cells=s.split(",").map(x=>x.trim());
    if(cells.length<2)continue;
    if(out.length===0 && /fund/i.test(cells[0])&&/ein/i.test(cells.at(-1)))continue;
    const ein=cells.at(-1);
    const fund=cells.slice(0,-1).join(", ");
    out.push({fund,ein});
  }
  return out;
}

async function fetchOne({fund,ein}){
  const r=await fetch(`${API}?fund=${encodeURIComponent(fund)}&ein=${encodeURIComponent(ein)}`);
  if(!r.ok) throw new Error(await r.text());
  const blob=await r.blob();
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=outName(fund);
  document.body.appendChild(a);
  a.click();a.remove();
  URL.revokeObjectURL(a.href);
}

document.getElementById("go").addEventListener("click", async()=>{
  log.textContent="";
  const rows=parseRows(document.getElementById("rows").value);
  if(!rows.length){say("Enter at least one line: Fund,EIN","err");return;}
  say(`Starting… ${rows.length} row(s)`);
  for(let i=0;i<rows.length;i++){
    const {fund,ein}=rows[i];
    try{say(`[${i+1}] Generating ${outName(fund)}…`);await fetchOne(rows[i]);say(`[${i+1}] OK`,"ok");}
    catch(e){say(`[${i+1}] ERROR: ${e.message}`,"err");}
  }
  say("Done.");
});
</script>
</body>
</html>
